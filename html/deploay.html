@echo off
CHCP 65001 > nul
setlocal enabledelayedexpansion

:: Define colors
set "RESET="
set "RED=[91m"
set "GREEN=[92m"
set "YELLOW=[93m"
set "BLUE=[94m"
set "CYAN=[96m"

echo.
echo %CYAN%============================================================%RESET%
echo %CYAN%       UNIVERSAL MERN DEPLOYMENT SCRIPT - v1.1%RESET%
echo %CYAN%============================================================%RESET%
echo.

:: ------------------ CONFIG ------------------
SET REMOTE_USER=sonusaini
SET REMOTE_HOST=10.0.11.194
SET LOCAL_BACKUP_DRIVE=D:
SET LOCAL_PROJECT_PATH=%~dp0

:: ------------------ INPUT ------------------
SET /p "PROJECT_NAME=%YELLOW%Enter a short, one-word name for this project (e.g., oms, crm): %RESET%"
IF "%PROJECT_NAME%"=="" ( echo %RED%[ERROR]%RESET% Project name cannot be empty. & pause & exit /b )

SET PM2_APP_NAME=%PROJECT_NAME%-api
SET REMOTE_PROJECT_PATH=/home/%REMOTE_USER%/%PROJECT_NAME%
SET NGINX_CONFIG_FILE=%PROJECT_NAME%.conf

echo %CYAN%--- Checking server for existing project... --- %RESET%
ssh %REMOTE_USER%@%REMOTE_HOST% "if [ -d %REMOTE_PROJECT_PATH% ]; then exit 0; else exit 1; fi"
IF %ERRORLEVEL% EQU 0 (
    SET DEPLOY_MODE=update
    echo %YELLOW%[INFO]%RESET% Project '%PROJECT_NAME%' found on server. Running UPDATE process.
    SET /p "BACKEND_PORT=Enter the EXISTING backend port for '%PROJECT_NAME%': "
) ELSE (
    SET DEPLOY_MODE=initial
    echo %GREEN%[INFO]%RESET% Project '%PROJECT_NAME%' not found. Running INITIAL DEPLOYMENT.
    SET /p "BACKEND_PORT=Enter a UNIQUE backend port for this NEW project (e.g., 5001, 5002): "
)

IF "%BACKEND_PORT%"=="" ( echo %RED%[ERROR]%RESET% Port cannot be empty. Aborting. & pause & exit /b )

:: ------------------ CLEANUP ------------------
IF EXIST "%LOCAL_PROJECT_PATH%backend\.env" ( move "%LOCAL_PROJECT_PATH%backend\.env" "%LOCAL_PROJECT_PATH%.env.temp" )
IF EXIST "%LOCAL_PROJECT_PATH%backend\node_modules" ( rmdir /s /q "%LOCAL_PROJECT_PATH%backend\node_modules" )
IF EXIST "%LOCAL_PROJECT_PATH%frontend\node_modules" ( rmdir /s /q "%LOCAL_PROJECT_PATH%frontend\node_modules" )
IF EXIST "%LOCAL_PROJECT_PATH%frontend\dist" ( rmdir /s /q "%LOCAL_PROJECT_PATH%frontend\dist" )

:: ------------------ BACKUP ------------------
SET /p "BACKUP_NOTES=%YELLOW%Enter a brief note for this deployment:%RESET% "
FOR /F "tokens=* USEBACKQ" %%F IN (`powershell -NoProfile -Command "Get-Date -Format 'yyyy-MM-dd_HH-mm-ss'"`) DO (SET TIMESTAMP=%%F)
SET LOCAL_BACKUP_PATH=%LOCAL_BACKUP_DRIVE%\backups\%PROJECT_NAME%\%DEPLOY_MODE%-%TIMESTAMP%
mkdir "%LOCAL_BACKUP_PATH%" > nul 2>&1
IF %ERRORLEVEL% NEQ 0 ( echo %RED%[ERROR]%RESET% Could not create backup directory. & pause & exit /b )
xcopy "%LOCAL_PROJECT_PATH%" "%LOCAL_BACKUP_PATH%\" /E /I /H /Y /Q
echo Deployment Date: %TIMESTAMP% > "%LOCAL_BACKUP_PATH%\readme.txt"
echo Deployment Type: %DEPLOY_MODE% >> "%LOCAL_BACKUP_PATH%\readme.txt"
echo Notes: %BACKUP_NOTES% >> "%LOCAL_BACKUP_PATH%\readme.txt"
echo %GREEN%--- Backup created successfully --- %RESET%


:: ------------------ FILE TRANSFER ------------------
echo %CYAN%--- Transferring files to remote server... --- %RESET%
ssh %REMOTE_USER%@%REMOTE_HOST% "mkdir -p %REMOTE_PROJECT_PATH%"
scp -r "%LOCAL_PROJECT_PATH%backend" "%REMOTE_USER%@%REMOTE_HOST%:%REMOTE_PROJECT_PATH%"
scp -r "%LOCAL_PROJECT_PATH%frontend" "%REMOTE_USER%@%REMOTE_HOST%:%REMOTE_PROJECT_PATH%"
scp "%LOCAL_PROJECT_PATH%remote-deploy.sh" "%REMOTE_USER%@%REMOTE_HOST%:%REMOTE_PROJECT_PATH%"

IF EXIST "%LOCAL_PROJECT_PATH%backend\.env.server" (
    scp "%LOCAL_PROJECT_PATH%backend\.env.server" "%REMOTE_USER%@%REMOTE_HOST%:%REMOTE_PROJECT_PATH%/backend/"
) ELSE (
    echo %RED%[ERROR]%RESET% Missing backend\.env.server file. Aborting.
    goto cleanup_and_exit
)

IF %ERRORLEVEL% NEQ 0 ( echo %RED%[ERROR]%RESET% File transfer failed. & goto cleanup_and_exit )

:: ------------------ REMOTE DEPLOY ------------------
SET "SUDO_PASS=Admin@1234@"  :: Replace securely in production

echo %CYAN%--- Running deployment script remotely... --- %RESET%
ssh %REMOTE_USER%@%REMOTE_HOST% "chmod +x %REMOTE_PROJECT_PATH%/remote-deploy.sh && %REMOTE_PROJECT_PATH%/remote-deploy.sh \"!DEPLOY_MODE!\" \"!PROJECT_NAME!\" \"!REMOTE_PROJECT_PATH!\" \"!PM2_APP_NAME!\" \"!REMOTE_HOST!\" \"!BACKEND_PORT!\" \"!SUDO_PASS!\""

IF %ERRORLEVEL% NEQ 0 (
    echo.
    echo %RED%*******************************************************************%RESET%
    echo %RED%***   ERROR: Remote deployment script FAILED.                  ***%RESET%
    echo %RED%***   If initial, cleanup was attempted. If update, app is live.***%RESET%
    echo %RED%*******************************************************************%RESET%
    goto cleanup_and_exit
)

:: ------------------ LOCAL RESTORE ------------------
:cleanup_and_exit
echo %CYAN%--- Restoring local files... ---%RESET%
IF EXIST "%LOCAL_PROJECT_PATH%.env.temp" ( move "%LOCAL_PROJECT_PATH%.env.temp" "%LOCAL_PROJECT_PATH%backend\.env" )
cd /d "%LOCAL_PROJECT_PATH%frontend" & call npm install > nul
cd /d "%LOCAL_PROJECT_PATH%backend" & call npm install > nul

echo.
echo %GREEN%--- DEPLOYMENT COMPLETE --- %RESET%
echo %BLUE%Application '%PROJECT_NAME%' deployed to: http://%REMOTE_HOST%/%PROJECT_NAME%/%RESET%
echo.
pause
exit /b


-----------------------------------------------------
#!/bin/bash

# ------------------ VARIABLES ------------------
DEPLOY_MODE=$1
PROJECT_NAME=$2
REMOTE_PROJECT_PATH=$3
PM2_APP_NAME=$4
REMOTE_HOST=$5
BACKEND_PORT=$6
SUDO_PASS=$7

# ------------------ STYLING ------------------
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# ------------------ CLEANUP ON FAIL ------------------
cleanup() {
  echo -e "${RED}--- [SERVER] FAILED at line $1: '$2'. Starting cleanup... ---${NC}"
  if [ "$DEPLOY_MODE" = "initial" ]; then
    echo -e "${YELLOW}--- [SERVER] Initial deployment. Cleaning up... ---${NC}"
    pm2 delete "$PM2_APP_NAME" || true
    pm2 save --force
    rm -rf "$REMOTE_PROJECT_PATH"
    echo -e "${YELLOW}--- [SERVER] Removed: $REMOTE_PROJECT_PATH ---${NC}"
  else
    echo -e "${YELLOW}--- [SERVER] Update mode. No cleanup done. ---${NC}"
  fi
}

trap 'cleanup $LINENO "$BASH_COMMAND"' ERR
set -e

# ------------------ ENVIRONMENT SETUP ------------------
export NVM_DIR="$HOME/.nvm"
[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"

echo -e "${CYAN}=====================================================${NC}"
echo -e "${CYAN}--- [SERVER] Deploying '$PROJECT_NAME' in '$DEPLOY_MODE' mode ---${NC}"
echo -e "${CYAN}=====================================================${NC}"

# ------------------ FRONTEND BUILD ------------------
cd "$REMOTE_PROJECT_PATH/frontend"
echo -e "${CYAN}--- [SERVER] Installing frontend dependencies ---${NC}"
npm install

echo -e "${CYAN}--- [SERVER] Generating frontend .env file ---${NC}"
cat > "$REMOTE_PROJECT_PATH/frontend/.env" << EOF
VITE_API_URL=http://${REMOTE_HOST}/api
EOF

echo -e "${CYAN}--- [SERVER] Building frontend ---${NC}"
npm run build

# ------------------ BACKEND SETUP ------------------
cd "$REMOTE_PROJECT_PATH/backend"
echo -e "${CYAN}--- [SERVER] Installing backend dependencies ---${NC}"
npm install

echo -e "${CYAN}--- [SERVER] Setting backend environment variables ---${NC}"
if [ ! -f "$REMOTE_PROJECT_PATH/backend/.env.server" ]; then
  echo -e "${RED}Missing .env.server file. Aborting.${NC}"
  exit 1
fi

mv "$REMOTE_PROJECT_PATH/backend/.env.server" "$REMOTE_PROJECT_PATH/backend/.env"

# ------------------ PM2 PROCESS MANAGEMENT ------------------
if [ "$DEPLOY_MODE" = "initial" ]; then
  echo -e "${CYAN}--- [SERVER] Starting backend with PM2 ---${NC}"
  pm2 start index.js --name "$PM2_APP_NAME"
  pm2 save
  pm2 startup systemd --user --hp "$HOME" || true
else
  echo -e "${CYAN}--- [SERVER] Restarting backend with PM2 ---${NC}"
  pm2 restart "$PM2_APP_NAME"
fi

# ------------------ NGINX CONFIGURATION ------------------
if [ "$DEPLOY_MODE" = "initial" ]; then
  MASTER_NGINX_CONF="/etc/nginx/sites-available/master-apps.conf"

  if grep -q "# Config for ${PROJECT_NAME} app" "$MASTER_NGINX_CONF"; then
    echo -e "${YELLOW}--- [SERVER] Nginx config for ${PROJECT_NAME} exists. Skipping. ---${NC}"
  else
    TEMP_NGINX_BLOCK_FILE="/tmp/${PROJECT_NAME}_nginx_block.conf"
    echo -e "${CYAN}--- [SERVER] Creating nginx block for ${PROJECT_NAME} ---${NC}"
    cat > "$TEMP_NGINX_BLOCK_FILE" <<EOF
# Config for ${PROJECT_NAME} app - START
location /${PROJECT_NAME}/ {
    alias ${REMOTE_PROJECT_PATH}/frontend/dist/;
    try_files \$uri \$uri/ /${PROJECT_NAME}/index.html;
}

location /${PROJECT_NAME}/api/ {
    rewrite ^/${PROJECT_NAME}/api/(.*) /api/\$1 break;
    proxy_pass http://localhost:${BACKEND_PORT};
    proxy_http_version 1.1;
    proxy_set_header Upgrade \$http_upgrade;
    proxy_set_header Connection 'upgrade';
    proxy_set_header Host \$host;
    proxy_cache_bypass \$http_upgrade;
}
# Config for ${PROJECT_NAME} app - END
EOF

    echo "$SUDO_PASS" | sudo -S sed -i "/# --- LOCATION BLOCKS FOR APPS WILL BE DYNAMICALLY ADDED HERE ---/r $TEMP_NGINX_BLOCK_FILE" "$MASTER_NGINX_CONF"
    rm "$TEMP_NGINX_BLOCK_FILE"
    echo -e "${GREEN}--- [SERVER] Nginx block for ${PROJECT_NAME} added ---${NC}"
  fi
fi

# ------------------ NGINX RELOAD ------------------
echo -e "${CYAN}--- [SERVER] Validating nginx config ---${NC}"
echo "$SUDO_PASS" | sudo -S nginx -t

echo -e "${CYAN}--- [SERVER] Restarting nginx ---${NC}"
echo "$SUDO_PASS" | sudo -S systemctl restart nginx

echo -e "${GREEN}=====================================================${NC}"
echo -e "${GREEN}--- [SERVER] Deployment complete for ${PROJECT_NAME} ---${NC}"
echo -e "${GREEN}=====================================================${NC}"
